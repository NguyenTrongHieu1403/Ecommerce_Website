@model List<ecommerce_final.Models.CartItemVM>

@{
    ViewData["Title"] = "Giỏ hàng";
}

<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">Shopping Cart<span>Shop</span></h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->

    <div class="page-content">
        <div class="cart">
            <div class="container">
                <div class="row">
                    <div class="col-lg-9">
                        <table class="table table-cart table-mobile">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>

                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr data-id="@item.MaHh">
                                        <td class="product-col">
                                            <div class="product">
                                                <figure class="product-media">
                                                    <a href="#">
                                                        <img src="@item.Hinh" alt="@item.TenHh" height="50" />
                                                    </a>
                                                </figure>
                                                <h3 class="product-title">
                                                    <a href="#">@item.TenHh</a>
                                                </h3>
                                            </div>
                                        </td>
                                        <td class="price-col">$@item.DonGia.ToString("N2")</td>
                                        <td class="quantity-col">
                                            <div class="cart-product-quantity">
                                                <input type="number" class="form-control quantity" value="@item.SoLuong" min="1" max="10" step="1" required />
                                            </div>
                                        </td>
                                        <td class="total-col">$@((item.DonGia * item.SoLuong).ToString("N2"))</td>
                                        <td class="remove-col">
                                            <a href="@Url.Action("RemoveCart", "Cart", new { id = item.MaHh })" class="btn-remove"><i class="icon-close"></i></a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table><!-- End .table table-cart -->

                        <div class="cart-bottom">
                            <a href="#" class="btn btn-outline-dark-2" id="updateCart"><span>UPDATE CART</span><i class="icon-refresh"></i></a>
                        </div><!-- End .cart-bottom -->
                    </div><!-- End .col-lg-9 -->

                    <aside class="col-lg-3">
                        <div class="summary summary-cart">
                            <h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->
                            <table class="table table-summary">
                                <tbody>
                                    <tr class="summary-subtotal">
                                        <td>Subtotal:</td>
                                        <td>$@Model.Sum(item => item.DonGia * item.SoLuong).ToString("N2")</td>
                                    </tr>
                                    <tr class="summary-total">
                                        <td>Total:</td>
                                        <td>$@Model.Sum(item => item.DonGia * item.SoLuong).ToString("N2")</td>
                                    </tr>
                                </tbody>
                            </table><!-- End .table table-summary -->

                            <a href="@Url.Action("Checkout", "Cart")" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a>
                        </div><!-- End .summary -->
                    </aside><!-- End .col-lg-3 -->
                </div><!-- End .row -->
            </div><!-- End .container -->
        </div><!-- End .cart -->
    </div><!-- End .page-content -->
</main>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $(".quantity").on("change", function () {
            var row = $(this).closest("tr");
            var id = row.data("id");
            var qty = $(this).val();

            $.ajax({
                url: '@Url.Action("UpdateCart", "Cart")',
                type: 'POST',
                data: { id: id, qty: qty },
                success: function (response) {
                    row.find(".total-col").text("$" + response.total.toFixed(2));
                    $(".summary-subtotal td:nth-child(2)").text("$" + response.subtotal.toFixed(2));
                    $(".summary-total td:nth-child(2)").text("$" + response.total.toFixed(2));
                },
                error: function () {
                    alert("Có lỗi xảy ra khi cập nhật giỏ hàng.");
                }
            });
        });

        $("#updateCart").click(function () {
            location.reload();
        });
    });
</script>
